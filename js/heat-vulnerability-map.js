'use strict'

mapboxgl.accessToken = 'pk.eyJ1IjoibWl0Y2l2aWNkYXRhIiwiYSI6ImNpbDQ0aGR0djN3MGl1bWtzaDZrajdzb28ifQ.quOF41LsLB5FdjnGLwbrrg'

var map = new mapboxgl.Map({
	container: 'map',
	style: 'mapbox://styles/mitcivicdata/ckgl88gzg4tr619pbvcluqluk', // stylesheet location
	center: [-73.924020, 40.761744], // starting position [lng, lat]
	zoom: 10.85 // starting zoom
});


// zoom nav buttons
let navigation = new mapboxgl.NavigationControl({
	showCompass: false
})
map.addControl(navigation, 'top-right');

// click popup tooltip
function hviScale(score, attr) {
	if (attr == "text") {
		return (score == 5) ? "high"
		: (score == 4) ? "med-high"
		: (score == 3) ? "med"
		: (score == 2) ? "med-low"
		: (score == 1) ? "low"
		: "";
	}
	else if (attr == "color") {
		return (score == 5) ? "#d25544"
		: (score == 4) ? "#ea9081"
		: (score == 3) ? "#f4cabd"
		: (score == 2) ? "#6a8e97"
		: (score == 1) ? "#024959"
		: "#000";
	}
	else if (attr == "img") {
		return (score == 5) ? "./img/heat-vulnerability/hvi-grey-5.svg"
		: (score == 4) ? "./img/heat-vulnerability/hvi-grey-4.svg"
		: (score == 3) ? "./img/heat-vulnerability/hvi-grey-3.svg"
		: (score == 2) ? "./img/heat-vulnerability/hvi-grey-2.svg"
		: (score == 1) ? "./img/heat-vulnerability/hvi-grey-1.svg"
		: "";
	}
}

function showPopup(e, feature) {
	if (feature.properties.HVI == 0) {
		return ;
	}

	var popup = new mapboxgl.Popup({
		offset: [0, 0],
		closeButton: false
	})
		.setLngLat(e.lngLat)
		.setHTML("<div class='labelplace'><p class='labelcd'>" + feature.properties.cdName + "</p><p class='labelborough'>" + feature.properties.borough + "</p><div class='labelhvi' style='color:" + hviScale(feature.properties.HVI, "color") + ";'><span class='data2'>" + hviScale(feature.properties.HVI, "text") + "</span><span class='data1'>" + feature.properties.HVI + "</span></div></div><div class='factors'><p class='labelhvifactors'>HVI Factors</p><div class='labelfactor right'><img src=" + hviScale(feature.properties.temp_sc, "img") + "><span style='color:" + hviScale(feature.properties.temp_sc, "color") + ";'>" + hviScale(feature.properties.temp_sc, "text") + "</span><p>Surface Temperature</p></div><div class='labelfactor'><img src=" + hviScale(feature.properties.veg_sc, "img") + "><span style='color:" + hviScale(feature.properties.veg_sc, "color") + ";'>" + hviScale(feature.properties.veg_sc, "text") + "</span><p>Area Covered by Vegetation</p></div><div class='labelfactor'><img src=" + hviScale(feature.properties.black_sc, "img") + "><span style='color:" + hviScale(feature.properties.black_sc, "color") + ";'>" + hviScale(feature.properties.black_sc, "text") + "</span><p>Non-White Population</p></div><div class='labelfactor'><img src=" + hviScale(feature.properties.poverty_sc, "img") + "><span style='color:" + hviScale(feature.properties.poverty_sc, "color") + ";'>" + hviScale(feature.properties.poverty_sc, "text") + "</span><p>People in Poverty</p></div><div class='labelfactor'><img src=" + hviScale(feature.properties.ac_sc, "img") + "><span style='color:" + hviScale(feature.properties.ac_sc, "color") + ";'>" + hviScale(feature.properties.ac_sc, "text") + "</span><p>No Access to Air Conditioner</p></div></div>")
		.addTo(map);
}

map.on('click', function(e) {
	var features = map.queryRenderedFeatures(e.point, {
		layers: ['heat-vulnerability-index']
	});

	if (!features.length) {
		return;
	}

	var feature = features[0];

	showPopup(e, feature);
});

map.on('load', function() {
	var e = {lngLat: [-73.94020996898772, 40.79491737652384]}
	var feature = {
		properties: {
			cdName: 'East Harlem',
			borough: 'Manhattan',
			HVI: 4,
			ac_sc: 4,
			temp_sc: 2,
			poverty_sc: 5,
			veg_sc: 4,
			black_sc: 4
		}
	};

	showPopup(e, feature);
});