const dataset = d3.csv("./data/heat-vulnerability-index.csv")
	.then(function(data) {
		data.forEach(function(d) {
			boroCD: +d.boroCD;
			cdName: d.cdName;
			borough: d.borough;
			temp: +d.temp;
			tempScaled: +d.tempScaled;
			veg: +d.veg;
			vegScaled: +d.vegScaled;
			poverty: +d.poverty;
			povertyScaled: +d.povertyScaled;
			black: +d.black;
			blackScaled: +d.blackScaled;
			ac: +d.ac;
			acScaled: +d.acScaled;
			hvi: +d.hvi;
		});

		if (!keys.length) {
			keys = data.columns;
		};
		if (!features.length) {
			features = data.columns.slice(3);
		};
		if (!featuresScaled.length) {
			featuresScaled = features.filter((item) => item.endsWith("Scaled"));
		}

		// store data to be sorted via click function
		districtData = data;

		// data for borough average
		const distinct = (value, index, self) => {
			return self.indexOf(value) === index;
		};

		// borough list
		boroughList = data.map(function(item) {	return item.borough})
			.filter(distinct);

		for (var b = 0; b < boroughList.length; b++) {
			let borough = boroughList[b];
			item = {};

			for (var i = 0; i < features.length; i++) {
				let property = features[i];
				totalBorough = data.filter(d => d.borough == borough).reduce((accumulator, value) => (accumulator + +value[property]), 0);
				neighborhoodsPerBorough = data.filter(d => d.borough == borough).length;
				(borough == "Manhattan") ? (item.boroCD = "100")
					: (borough == "Bronx") ? (item.boroCD = "200")
					: (borough == "Brooklyn") ? (item.boroCD = "300")
					: (borough == "Queens") ? (item.boroCD = "400")
					: (borough == "Staten Island") ? (item.boroCD = "500")
					: item.boroCD = undefined;
				item.neighborhoods = neighborhoodsPerBorough;
				item.borough = borough;
				item[property] = totalBorough/neighborhoodsPerBorough;
				if (property.endsWith("Scaled") || property == "hvi") {
					item[property] = Math.round(item[property]);
				} else {
					item[property] = roundAccurately(item[property], 1);
				}
			};
			boroughAverage.push(item);
		};

		// profile data on load
		profileData = [data[26], data[6]];

		// sorted data on load
		allData = boroughAverage.sort((a,z) => d3.ascending(a.borough, z.borough))
				.sort((a, z) => d3.descending(a.hvi, z.hvi))
			.concat(data.sort((a, z) => d3.ascending(a.cdName, z.cdName))
				.sort((a, z) => d3.ascending(a.borough, z.borough))
				.sort((a, z) => d3.descending(a.hvi, z.hvi))
			);

		// plot data & display on load
		plotAllData(allData);

		compareProfile(profileData);
		// plotProfileRow(profileData);
		// divProfile1.html((divHtml) => profileTooltip(profileData[0]));
		// divProfile2.html((divHtml) => profileTooltip(profileData[1]));
		// divProfileFeatures.html((divHtml) => profileFeatures(profileData[0], profileData[1]));

		console.log(data);
		console.log(boroughAverage);
		console.log(profileData);
	});

// aspect ratio
const width = 950;
const rowHeight = 24;
const hexOffset = 400;

var winHeight = $(window).height();

// define svg
const svg = d3.select("#hvi-data")
	.append("svg")
		.attr("id", "hvi-chart")
		.attr("class", "hvi-chart")
		// .attr("viewBox", [0, 0, width, rowHeight * data.length])

// tooltip
var div = d3.select("body").append("div")
	.attr("id", "tooltip")
	.style("display", "none")
	.style('z-index', '10')
	.text("info");

var divProfile1 = d3.select("#profile1>.profile-tooltip")
	.html("");

var divProfile2 = d3.select("#profile2>.profile-tooltip")
	.html("");
var divProfileFeatures = d3.select("#profile-features")
	.html("");

// manipulated datasets
let keys = [];
let features = [];
let featuresScaled = [];
let categories = ["Surface Temperature", "Vegetation Cover", "Non-White Population", "People in Poverty", "No Access to Air Conditioner"];

let boroughList = [];
let boroughAverage = [];
let districtData = [];
// data for profile highligh
let profileData = [];
// sorted data
let allData = [];

// round accurately function
function roundAccurately(number, decimalPlaces) {
	return Number(Math.round(number + "e" + decimalPlaces) + "e-" + decimalPlaces);	
};

// colors
const featureColor = d3.scaleOrdinal()
	.domain(categories)
	.range(["#dcc651", "#2d7f64", "#424d9b", "#8f2e62", "#f05d43"])
	.unknown("#444444");

// tooltip info per datapoint
function datapointTooltip(d) {
	return (d.feature == "temp") ? d[d.feature] + "&deg;F&ensp;Surface Temperature"
	: (d.feature == "veg") ? d[d.feature] + "%&ensp;Vegetation Cover"
	: (d.feature == "black") ? d[d.feature] + "%&ensp;Non-White Population"
	: (d.feature == "poverty") ? d[d.feature] + "%&ensp;People in Poverty"
	: (d.feature == "ac") ? d[d.feature] + "%&ensp;No Access to Air Conditioner"
	: "";
}

function profileTooltip(d) {
	if (d.borough == "Bronx") {var boroughAbbr = "BX";}
	else if (d.borough == "Brooklyn") {var boroughAbbr = "BK";}
	else if (d.borough == "Manhattan") {var boroughAbbr = "MN";}
	else if (d.borough == "Queens") {var boroughAbbr = "QN";}
	else if (d.borough == "Staten Island") {var boroughAbbr = "SI";}

	if (d.hvi == 1) {var hviWord = "low";}
	else if (d.hvi == 2) {var hviWord = "med-low";}
	else if (d.hvi == 3) {var hviWord = "med";}
	else if (d.hvi == 4) {var hviWord = "med-high";}
	else if (d.hvi == 5) {var hviWord = "high";}

	return (!d.cdName) ? "<h4 class='profile-place'>" + d.borough + "</h4><span class='data1'>" + d.hvi + "</span><p>" + hviWord + "</p><p>Heat Vulnerability</p><p class='profile-compared'>compared to other NYC boroughs</p>" 
	: "<h4 class='profile-place'>" + d.cdName + ", " + boroughAbbr + "</h4><span class='data1'>" + d.hvi + "</span><p>" + hviWord + "</p><p>Heat Vulnerability</p><p class='profile-compared'>compared to other NYC neighborhoods</p>";
}

function profileFeatures(d0, d1) {
	let profileString = "";

	for (var i = 0; i < featuresScaled.length; i++) {
		let featureName = featuresScaled[i].slice(0, -6);
		let featureDifference = roundAccurately((d0[featureName] - d1[featureName]), 1);

		if (featureDifference > 0) {
			var arrowImg = "arrow-more.svg";
			var differenceWord = "higher";
		} else if (featureDifference == 0) {
			var arrowImg = "arrow-same.svg";
			var differenceWord = "same";
		} else if (featureDifference < 0) {
			var arrowImg = "arrow-less.svg";
			var differenceWord = "lower";
		}

		if (featureName == "temp") {
			var featureString = "<div id='feature-" + featureName + "' class='feature-difference'><img src='./img/heat-vulnerability/" + arrowImg + "'><p class='label-difference'>" + featureDifference + "&deg; " + differenceWord + "</p><p>" + categories[i] + "</p></div>";
		} else {
			var featureString = "<div id='feature-" + featureName + "' class='feature-difference'><img src='./img/heat-vulnerability/" + arrowImg + "'><p class='label-difference'>" + featureDifference + "% " + differenceWord + "</p><p>" + categories[i] + "</p></div>";
		}

		profileString += featureString;
	}
	return profileString + "<div class='hvi-difference'>Heat Vulnerability Index</div>";
}

// draw hexagon row
const hexRadius = 10;
var hexbin = d3.hexbin()
	.radius(hexRadius);

function getHexCoordinates(dataPoint) {
	var points = [];
	for (var i = 0; i < (featuresScaled.length * 5); i++) {
			if (i < 5) {
				var f = 0;
			} else if (i < 10) {
				var f = 1;
			} else if (i < 15) {
				var f = 2;
			} else if (i < 20) {
				var f = 3;
			} else {
				var f = 4;
			}
			let featureName = featuresScaled[f].slice(0, -6);
			let featureScaled = featuresScaled[f];

			let item = [];
			// center position of each hexagon
			item.x = hexOffset + i * hexRadius * Math.sqrt(3);
			item.y = rowHeight/2;
			// add data for tooltip
			item.feature = featureName;
			item[featureName] = dataPoint[featureName];
			item[featureScaled] = dataPoint[featureScaled];
			item.boroCD = dataPoint.boroCD;
			item.cdName = dataPoint.cdName;
			item.borough = dataPoint.borough;
			if ((i - f*5) < dataPoint[featureScaled]) {
				item.fill = featureColor(categories[f]);
			} else {
				item.fill = "#fff";
			}

			points.push(item);
	};
	return points;
}

function plotHexagons(svg, data) {
	let hexData = getHexCoordinates(data);

	svg.append("g")
			.attr("class", "hex-row")
		.selectAll("path")
		.data(hexData)
		.enter()
		.append("path")
			.attr("class", (d) => "hexagon-" + d.boroCD)
			.attr("d", (d) => {
				return "M" + d.x  + "," + d.y + hexbin.hexagon();
			})
			.attr("stroke", "#000")
			.attr("stroke-width", "1px")
			.style("fill", (d) => d.fill)
};

function plotProfileRow(data) {
	for (var i = 0; i < data.length; i++) {
		if (i == 0) {
			var divID = "#profile1";
		} else {
			var divID = "#profile2";
		}
		let chartID = "#chart" + data[i].boroCD;
		let rowData = [data[i]];

		const svgProfileRow = d3.select(divID)
			.append("svg")
				.attr("id", "chart" + data[i].boroCD)
				.attr("class", "svg-hvi-profile")
				.attr("viewBox", [0, 0 - rowHeight*2, width, rowHeight*4])

		plotHexagons(svgProfileRow, data[i]);

		svgProfileRow.append("g")
				.attr("class", "text-hvi")
			.selectAll("text")
			.data(rowData)
			.enter()		
			.append("text")
				.attr("class", "labelhviscore")
				.text((d) => "HVI = " + d.hvi)
				.attr("text-anchor", "start")
				.attr("x", hexOffset + 44 * hexRadius)
				.attr("y", rowHeight - 7)

		// hover data
		svgProfileRow.select(".hex-row")
			.selectAll("path")
			.on("mouseover", function(event, d) {
				div.html((divHtml) => datapointTooltip(d))
					.style("color", "#000")
					// .style("color", (divHtml) => featureColor(datapointTooltip(d.feature)))
					.style("display", "block")
			})
			.on("mousemove", function(event) {
				div.style("top", (divHtml) => {
						var divY = event.pageY;
						var tooltipHeight = $("#tooltip").outerHeight();
						var displayHeight = $("#hvi-data").height();
						if ((divY - winHeight + tooltipHeight) > displayHeight) {
							divY = divY - tooltipHeight - 10;
						};
						return (divY + 10) + "px"
					})
					.style("left", (divHtml) => {
						var divX = event.pageX;
						var tooltipWidth = $("#tooltip").outerWidth();
						var displayWidth = $(window).width();
						if ((divX + tooltipWidth) > displayWidth) {
							divX = divX - tooltipWidth - 10;
						};
						return (divX + 10) + "px"
					})
			})
			.on("mouseout", function() {
				div.style("display", "none");
			})
	}
}

function plotAllData(data) {
	svg.attr("viewBox", [0, 0, width, rowHeight * data.length])

	for (var i = 0; i < data.length; i++) {
		let chartID = "#chart" + data[i].boroCD;
		let rowData = [data[i]];

		const dataRow = svg.append("g")
			.attr("id", "chart" + data[i].boroCD)

		dataRow.selectAll("rect")
			.data(rowData)
			.enter()
			.append("rect")
				.attr("x", 0)
				.attr("y", (rowHeight * i))
				.attr("width", width)
				.attr("height", rowHeight)
				.attr("fill", "#d1d3d4")
				.attr("opacity", (d) => {
					return (d.boroCD == profileData[0].boroCD || d.boroCD == profileData[1].boroCD) ? 1
					: 0;
				})
			.on("click", function(event, d) {
					var clickedData = allData.filter((data) => data.boroCD == d.boroCD);
					profileData.shift();
					profileData = profileData.concat(clickedData);
					$(".svg-hvi-profile").remove();
					compareProfile(profileData);
			})

		// plotHexagons(svg, data[i]);
		let hexData = getHexCoordinates(data[i]);

		dataRow.append("g")
				.attr("class", "hex-row")
			.selectAll("path")
			.data(hexData)
			.enter()
			.append("path")
				.attr("class", (d) => "hexagon-" + d.boroCD)
				.attr("d", (d) => {
					return "M" + d.x  + "," + (d.y + (rowHeight * i)) + hexbin.hexagon();
				})
				.attr("stroke", "#000")
				.attr("stroke-width", "1px")
				.style("fill", (d) => d.fill)
		
		dataRow.selectAll("text.labelplace")
			.data(rowData)
			.enter()
			.append("text")
				.attr("class", "labelplace")
				.text((d) => {
					return (!d.cdName) ? d.borough
					: (d.borough == "Bronx") ? d.cdName + ", BX"
					: (d.borough == "Brooklyn") ? d.cdName + ", BK"
					: (d.borough == "Manhattan") ? d.cdName + ", MN"
					: (d.borough == "Queens") ? d.cdName + ", QN"
					: (d.borough == "Staten Island") ? d.cdName + ", SI"
					: d.cdName;
				})
				.attr("text-anchor", "end")
				.attr("x", hexOffset - 25)
				.attr("y", (rowHeight * (i + 1)) - 7)

		dataRow.selectAll("text.labelhviscore")
			.data(rowData)
			.enter()		
			.append("text")
				.attr("class", "labelhviscore")
				.text((d) => {
					return (!d.cdName) ? "Avg. HVI = " + d.hvi
					: "HVI = " + d.hvi
				})
				.attr("text-anchor", "start")
				.attr("x", hexOffset + 44 * hexRadius)
				.attr("y", (rowHeight * (i + 1)) - 7)

		dataRow.selectAll("text")
			.on("click", function(event, d) {
					var clickedData = allData.filter((data) => data.boroCD == d.boroCD);
					profileData.shift();
					profileData = profileData.concat(clickedData);
					$(".svg-hvi-profile").remove();
					compareProfile(profileData);
			})

		// hover data
		dataRow.select(".hex-row")
			.selectAll("path")
			.on("mouseover", function(event, d) {
				div.html((divHtml) => datapointTooltip(d))
					.style("color", "#000")
					// .style("color", (divHtml) => featureColor(datapointTooltip(d.feature)))
					.style("display", "block")
			})
			.on("mousemove", function(event) {
				div.style("top", (divHtml) => {
						var divY = event.pageY;
						var tooltipHeight = $("#tooltip").outerHeight();
						if ((divY - winHeight + tooltipHeight) > winHeight) {
							divY = divY - tooltipHeight - 10;
						};
						return (divY + 10) + "px"
					})
					.style("left", (divHtml) => {
						var divX = event.pageX;
						var tooltipWidth = $("#tooltip").outerWidth();
						var displayWidth = $(window).width();
						if ((divX + tooltipWidth) > displayWidth) {
							divX = divX - tooltipWidth - 10;
						};
						return (divX + 10) + "px"
					})
			})
			.on("mouseout", function() {
				div.style("display", "none");
			})
			.on("click", function(event, d) {
					var clickedData = allData.filter((data) => data.boroCD == d.boroCD);
					profileData.shift();
					profileData = profileData.concat(clickedData);
					$(".svg-hvi-profile").remove();
					compareProfile(profileData);
			})
	}
}

// compare profile data
function compareProfile(profileData) {
	plotProfileRow(profileData);
	divProfile1.html((divHtml) => profileTooltip(profileData[0]));
	divProfile2.html((divHtml) => profileTooltip(profileData[1]));
	divProfileFeatures.html((divHtml) => profileFeatures(profileData[0], profileData[1]));

	for (var i = 0; i < allData.length; i++) {
		let chartID = "#chart" + allData[i].boroCD;
		let rowData = [allData[i]];

		const dataRow = svg.select(chartID);

		dataRow.selectAll("rect")
			.data(rowData)
				.attr("y", (rowHeight * i))
				.attr("opacity", (d) => {
					return (d.boroCD == profileData[0].boroCD || d.boroCD == profileData[1].boroCD) ? 1
					: 0;
				})
	}
};

// sort data on click
function sortData(property) {
	if (property == "place") {
		allData = boroughAverage.sort((a,z) => d3.ascending(a.borough, z.borough))
			.concat(districtData.sort((a, z) => d3.ascending(a.cdName, z.cdName))
				.sort((a,z) => d3.ascending(a.borough, z.borough)));
	} else if (property == "temp") {
		allData = boroughAverage.sort((a,z) => d3.descending(+a.temp, +z.temp))
			.concat(districtData.sort((a, z) => d3.descending(+a.temp, +z.temp)));
	} else if (property == "veg") {
		allData = boroughAverage.sort((a, z) => d3.descending(+a.veg, +z.veg))
			.concat(districtData.sort((a, z) => d3.descending(+a.veg, +z.veg)));
	} else if (property == "black") {
		allData = boroughAverage.sort((a, z) => d3.descending(+a.black, +z.black))
			.concat(districtData.sort((a, z) => d3.descending(+a.black, +z.black)));
	} else if (property == "poverty") {
		allData = boroughAverage.sort((a, z) => d3.descending(+a.poverty, +z.poverty))
			.concat(districtData.sort((a, z) => d3.descending(+a.poverty, +z.poverty)));
	} else if (property == "ac") {
		allData = boroughAverage.sort((a, z) => d3.descending(+a.ac, +z.ac))
			.concat(districtData.sort((a, z) => d3.descending(+a.ac, +z.ac)));
	} else if (property == "hvi") {
		allData = boroughAverage.sort((a,z) => d3.ascending(a.borough, z.borough))
				.sort((a, z) => d3.descending(+a.hvi, +z.hvi))
			.concat(districtData.sort((a, z) => d3.ascending(a.cdName, z.cdName))
				.sort((a, z) => d3.ascending(a.borough, z.borough))
				.sort((a, z) => d3.descending(+a.hvi, +z.hvi))
			);
	}

	for (var i = 0; i < allData.length; i++) {
		let chartID = "#chart" + allData[i].boroCD;
		let rowData = [allData[i]];

		const dataRow = svg.select(chartID);
		let hexData = getHexCoordinates(allData[i]);

		dataRow.selectAll("rect")
			.data(rowData)
				.attr("y", (rowHeight * i))
				.attr("opacity", (d) => {
					return (d.boroCD == profileData[0].boroCD || d.boroCD == profileData[1].boroCD) ? 1
					: 0;
				})

		dataRow.select(".hex-row")
			.selectAll("path")
			.data(hexData)
				.attr("d", (d) => {
					return "M" + d.x  + "," + (d.y + (rowHeight * i)) + hexbin.hexagon();
				})
		
		dataRow.selectAll("text.labelplace")
			.data(rowData)
				.attr("y", (rowHeight * (i + 1)) - 7)

		dataRow.selectAll("text.labelhviscore")
			.data(rowData)
				.attr("y", (rowHeight * (i + 1)) - 7)
	}
}

// display on load
$(document).ready(function(){
	$("#nav>ul>li>ul>li").addClass("grey");
	$("#hvi").addClass("sorted-feature").css("background", "#fff").css("color", "#000").css("border-color", "#000");
})

// nav borough filter display
function filterBoroughNav(boroughId) {
	$("#city").addClass("grey").css("color", "#d1d3d4");
	$("#borough").removeClass("grey").css("color", "#000");

	$("#nav>ul>li>ul>li").addClass("grey").css("color", "#d1d3d4");
	$("#" + boroughId).removeClass("grey").css("color", "#000");
	if (boroughId == "nyc") {
		$("#currentborough").html("&mdash;All");
	} else if (boroughId == "statenisland") {
		$("#currentborough").html("&mdash;Staten Island");
	}
	else {
		$("#currentborough").html("&mdash;" + boroughId);
	}
}

// nav clicks
$("#city").on("click", function() {
	$(this).removeClass("grey").css("color", "#000");
	$("#borough").addClass("grey").css("color", "#d1d3d4");

	$("#nav>ul>li>ul>li").addClass("grey").css("color", "#d1d3d4");
	$("#currentborough").html("");


});
$("#borough").on("click", function() {
	$(this).removeClass("grey").css("color", "#000");
	$("#city").addClass("grey").css("color", "#d1d3d4");

	$("#nav>ul>li>ul>li").addClass("grey").css("color", "#d1d3d4");
	$("#nyc").removeClass("grey").css("color", "#000");
	$("#currentborough").html("&mdash;All");

});
// nav click by filtering boroughs
$("#nav>ul>li>ul>li").on("click", function() {
	filterBoroughNav($(this).attr("id"));

	let chartBoroughClass = ".chart" + $(this).attr("id");
	$(chartBoroughClass).css("display", "block");
})

// toggle by weekday or weekend
$(".sort-button").on("click", function(e) {
	if (!$(this).hasClass("sorted-feature")) {
		$(".sorted-feature").removeClass("sorted-feature").css("background", "#d1d3d4").css("border-color", "#d1d3d4").css("color", "#333");
		$(this).addClass("sorted-feature").css("background", "#fff").css("border-color", "#000").css("color", "#000");

		sortData($(this).attr("id"));
	}
});
$(".sort-button").on("mouseover", function() {
	if ($(this).hasClass("sorted-feature")) {
		$(this).css("background", "#fff").css("border-color", "#000").css("color", "#000");
	}
	else {
		$(this).css("background", "#8c8c8c").css("border-color", "#8c8c8c").css("color", "#000");
	}
});
$(".sort-button").on("mouseleave", function() {
	if ($(this).hasClass("sorted-feature")) {
		$(this).css("background", "#fff").css("border-color", "#000").css("color", "#000");
	}
	else {
		$(this).css("background", "#d1d3d4").css("border-color", "#d1d3d4").css("color", "#333");
	}
});